---
sidebar: sidebar
permalink: use/replication.html
keywords: replicate, replication, disaster, recovery
summary: Astra can restore your application configuration and persistent storage from a snapshot or backup. Persistent storage backups are transferred from your object store, so restoring from an existing backup will complete the fastest.
---

= Replicate apps to a remote system using SnapMirror technology
:hardbreaks:
:icons: font
:imagesdir: ../media/use/

[.lead]
Using Astra Control, you can quickly protect applications to a remote cluster in preparation for disaster recovery using SnapMirror technology, a feature of ONTAP. The replication destination should be in another data center from which you could recover your applications, if needed.

Astra Control replicates application Snapshot copies to a remote cluster, providing scheduled, asynchronous, disaster recovery protection. The replication process includes volume snapshots (of the persistent volumes replicated by SnapMirror) and app metadata.

For a comparison between backups/restores and replication, see link:../concepts/data-protection.html[Data protection concepts].

The following images show the scheduled backup and restore process compared to the replication process.


The backup process copies data to S3 buckets and restores from S3 buckets:

image:acc-backup.png[Scheduled backup and restore image]

On the other hand, replication is done by replicating to ONTAP and then failing over that creates the Kubernetes resources on a destination cluster:

image:acc-replication.png[Replication and fail over image]

Using Astra Control, you can do the following tasks related to replicating applications:

* <<Set up a replication relationship>>
* <<Bring a replicated app online on the destination cluster (fail over)>>
* <<Resync a failed over replication>>
* <<Replicate applications back to the original cluster (fail back)>>
* <<Delete an application replication relationship>>


== Replication prerequisites

Replication to protect an app in Astra Control requires the following prerequisites that must be met before you begin:

* The app's host Kubernetes cluster and a destination Kubernetes cluster must be available and connected to two ONTAP clusters, ideally at different failure domains or sites.
* ONTAP clusters must be paired and paired before SVMs. See https://docs.netapp.com/us-en/ontap-sm-classic/peering/index.html[Cluster and SVM peering overview].
* The volumes' host SVM must be paired with the remote SVM.
* The paired remote SVM must be available to Trident on the destination cluster.
* Trident version 22.04 or greater must exist on both the source and destination ONTAP clusters.
* ONTAP SnapMirror asynchronous licenses using the Data Protection bundle must be enabled on both the source and destination ONTAP clusters. See https://docs.netapp.com/us-en/ontap/data-protection/snapmirror-licensing-concept.html[SnapMirror licensing overview in ONTAP].
* Both source and destination Kubernetes clusters and ONTAP clusters must be managed by Astra Control.


== Replication statuses and life cycle

Astra Control displays states for both the life cycle of the replication relationship and the health of the relationship itself.

The following statuses indicate the life cycle of the replication relationship:

* *Establishing*: A new replication relationship is being created. Astra Control creates a namespace if needed, creates PVCs on new volumes on the destination cluster, and creates SnapMirror relationships. This status can also indicate that the replication is resyncing or reversing replication.
* *Established*: A replication relationship exists. Astra Control periodically checks that the PVCs are available, checks the replication relationship, periodically creates Snapshots of the app, and identifies any new source PVCs in the app. If so, Astra Control creates the resources to include them in the replication.
* *Failing over*: Astra Control breaks the SnapMirror relationships and restores the app's Kubernetes resources from the last successfully replicated app Snapshot.

* *Failed over*: Astra Control uses the most recent (successful) replicated app Snapshot copy, stops replicating from the source cluster, and restores the Kubernetes resources.

* *Resyncing*: Astra Control stops the app that's running, removes the Kubernetes app, stops pods on the new destination and resyncs the SnapMirror relationships. During the resyncing process, the status shows as "Establishing."

* *Reversing*: Astra Control swaps the source and destination relationship. During the reverse replication, the status shows as "Establishing."

* *Deleting*:
** If the replication relationship was established but not failed over yet, Astra Control removes PVCs that were created during replication and deletes the destination managed app.
** If the replication was failed over already, Astra Control retains the PVCs and destination app.


The following states indicate the health of the replication relationship:

* *Normal*: The relationship is either establishing or has established, and the most recent Snapshot transferred successfully.
* *Warning*: The relationship is either failing over or has failed over (and therefore is no longer protecting the source app).
* *Critical*
** The relationship is establishing or failed over, and the last reconcile attempt failed.
** The relationship is established, and the last attempt to reconcile the addition of a new PVC is failing.
** The relationship is established (so a successful Snapshot has replicated, and failover is possible), but the most recent Snapshot failed or failed to replicate.


== Set up a replication relationship

Before replicating applications using Astra Control, you need to set up the replication relationship. Setting up this relationship involves the following that make up the replication policy;

* Choosing the destination cluster
* Choosing how frequently you want Astra Control to take an app Snapshot (which includes the app's Kubernetes resources as well as the volume Snapshots for each of the app's volumes)
* Setting the time for the Snapshot to be taken

TIP: To stop a replication from occurring again, you can change this replication relationship schedule. Alternatively, you can pause the replication using the https://docs.netapp.com/us-en/astra-automation/index.html[Astra Control API].

.Steps

. From the Astra Control left navigation, select *Applications*.
. In the Application page, select the *Data Protection* > *Replication* tab.
. In the Data Protection > Replication tab, select *Configure replication policy*. Or, from the Application Protection box, select the Actions option and select *Configure replication policy*.

. Enter or select the following information:
+
* Destination cluster
* *Destination storage class*: Select or enter the storage class that is used in the destination ONTAP cluster.
* *Replication type*: "Asynchronous" is currently the only replication type available. 
* *Destination namespace*: Enter a new or existing destination namespace for the destination cluster.
+
NOTE: Any conflicting resources in the selected namespace will be overwritten. 

* *Replication frequency*: Set how often you want Astra Control to take a Snapshot and replicate it to its destination.
* *Offset*: Set the number of minutes from the top of the hour that you want Astra Control to take a Snapshot. You might want to use an offset so that it doesn't coincide with other scheduled operations. For example, if you want to take the Snapshot every 5 minutes starting at 10:02, enter "02" as the offset minutes. The result would be 10:02, 10:07, 10:12, etc.

. Select *Next*, review the summary, and select *Save*.
+
NOTE: At first, the status displays "app-mirror" before the first schedule occurs.

. To see the application Snapshot status, select the *Applications* > *Snapshots* tab.
+
When the Snapshot backup occurs, the Snapshot name displays in the format of "replication-schedule-<string>". After the Snapshot is finished, Astra Control deletes the Snapshot from the original cluster.

.Result

This creates the replication relationship, creates a namespace on the destination (if it doesn't exist), and creates a PVC on the destination cluster on the destination namespace corresponding to the source app's PVCs. Astra Control also takes an initial Snapshot.

The Data Protection page shows the replication relationship status:
<Health state> | <Relationship life cycle>

For example:
Normal | Established

== Bring a replicated app online on the destination cluster (fail over)

Using Astra Control, you can replicate or "fail over" applications to a destination cluster. In the event of a disaster, or if the source cluster became unavailable, or just for periodic testing of your disaster recovery plan, you can use the fail over procedure to bring an application online on the destination cluster. 


.Steps
. From the Astra Control left navigation, select *Applications*.
. In the Application page, select the *Data Protection* > *Replication* tab.
. In the Data Protection > Replication tab, from the Actions menu, select *Fail over*.
. In the Fail over page, review the information and select *Fail over*.

.Result

The following actions occur as a result of bringing the application online on the destination cluster using the fail over procedure:

* On the destination cluster, an app is started based on the latest replicated state from the source app and continues to run based on the latest replicated state from the source app.

* The source app might be running and might continue to run (unless the cluster has failed). Astra Control does not stop the source app.

* The source and destination apps will diverge with updates occurring to either app.

* The replication status changes to "Failing over" and then to "Failed over" when it has completed.
* The source app's protection policy is copied to the destination app based on the schedules present on the source app at the time of the fail over.

* Astra Control shows the app both on the source and destination clusters.

== Resync a failed over replication

If replication has failed over (and the status is "Failed over") but it has not completed successfully, you might need to resync the replication. Resyncing replication re-establishes the replication relationship.

Resyncing starts with a failed over relationship (where no replication is occurring and both apps are running). The process stops the app on the new destination side, and re-establishes replication to that side. You can choose which app should be the new replication source and which one should be stopped to serve as the new destination.



NOTE: During the resync process, the life cycle status shows as "Establishing."

.Steps
. From the Astra Control left navigation, select *Applications*.
. In the Application page, select the *Data Protection* > *Replication* tab.
. In the Data Protection > Replication tab, from the Actions menu, select *Resync*.
. In the Resync page, select either the source or destination app instance containing the data that you want to preserve.
+
CAUTION: Be careful which side you select as the source.

. Select *Resync* to continue.
. Type "resync" to confirm.
. Select *Yes, resync* to finish.

.Result

* The Replication page shows "Establishing" as the replication status.
* After resyncing, the Replication page shows the updated relationship.
* ONTAP volumes are set to a “Data Protection” mode so that no data protection occurs during this time.

== Reverse application replication

With a relationship in an Established state, this process shuts down the app, replicates data written during the shutdown, and then starts the app on the other side, after which replication resumes in the opposite direction.

In this situation, you are swapping the source and destination. The original source cluster becomes the new destination cluster, and the original destination cluster becomes the new source cluster.

.Steps
. From the Astra Control left navigation, select *Applications*.
. In the Application page, select the *Data Protection* > *Replication* tab.
. In the Data Protection > Replication tab, from the Actions menu, select *Reverse replication*.
. In the Reverse Replication page, review the information and select *Reverse replication* to continue.

.Result

The following actions occur as a result of the fail back:

* Astra Control stops any writes to the original source app and takes a Snapshot of the original source app before beginning the reverse process.
* Then, the app is stopped on the original source cluster.
* Replication starts in reverse of the original direction, dropping any changes made to the original source app.
* Snapshot backup schedules are removed from the original source app (that is now the destination app).
* Original source app Kubernetes resources are removed, leaving only PVCs.
* The original source volume is changed from having read/write abilities to a data protection mode.
* Astra Control shows the app both on the source and destination clusters.

== Replicate applications back to the original cluster (fail back)

Using Astra Control, you can replicate or "fail back" applications from a destination cluster back to the original cluster. In this case, Astra Control makes the destination site the new primary and replicates applications back to the original cluster, similar to reversing replication. However, this starts from a relationship that has completed a fail over to a destination. Next, it replicates back to the original replication direction, but preserves the data written on the destination app while failed over.

This process involves the following tasks:

* Start with a failed over state.
* Resync the relationship.
* Reverse the replication.

.Steps
. From the Astra Control left navigation, select *Applications*.
. In the Application page, select the *Data Protection* > *Replication* tab.
. In the Data Protection > Replication tab, from the Actions menu, select *Resync*.
. Select the app instance containing the data that you want to preserve. You can select either the source or destination app instance to initiate the resync.

. Type "resync" to confirm.
. Select *Yes, resync* to finish.
. In the Data Protection > Replication tab, from the Actions menu, select *Reverse replication*.
. In the Reverse Replication page, review the information and select *Reverse replication*.

.Result

The following actions occur as a result of the fail back:

* Astra Control stops any writes to the original source app and takes a Snapshot of the original source app before beginning the fail back process.
* Then, the app is stopped on the original source cluster.
* Replication starts in reverse of the original direction, dropping any changes made to the original source app while failed over.
* The replication status changes to "Failed back."
* Snapshot backup schedules are removed from the original source app (that is now the destination app).
* Original source app Kubernetes resources are removed, leaving only PVCs.
* The original source volume is changed from having read/write abilities to a data protection mode.
* Astra Control shows the app both on the source and destination clusters.

== Delete an application replication relationship

When you no longer want to replicate applications to a remote system, you might want to delete the replication relationship. You can delete the relationship from either the source or destination managed app in Astra Control.

Deleting the relationship results in two separate apps with no relationship between them. Subsequently, the Applications Data Protection > Replication page shows a dotted line between the source and destination.

.Steps
. From the Astra Control left navigation, select *Applications*.
. In the Application page, select the *Data Protection* > *Replication* tab.
. In the Data Protection > Replication tab, from the Application Protection box or in the relationship diagram, select *Delete replication relationship*.
+
A dotted line appears in the diagram to indicate that there is no longer a relationship.

.Result

The following actions occur as a result of deleting a replication relationship:

* If the relationship is established but the app has not yet been brought online on the destination cluster (failed over), Astra Control retains PVCs created during initialization, leaves an "empty" managed app on the destination cluster, and retains the destination app to keep any backups that might have been created.

* If the app has been brought online on the destination cluster (failed over), Astra Control retains PVCs and destination apps. Source and destination apps are now treated as independent apps. The backup schedules remain on both apps but are not associated with each other. 
